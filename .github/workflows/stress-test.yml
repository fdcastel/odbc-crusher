name: Stress Test

on:
  workflow_dispatch:

jobs:

  # ── PostgreSQL on Linux ─────────────────────────────────────
  postgresql:
    name: PostgreSQL (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={PostgreSQL Unicode};Server=127.0.0.1;Port=5432;Database=postgres;Uid=postgres;Pwd=postgres;"
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start PostgreSQL
      run: |
        sudo systemctl start postgresql
        sudo systemctl status postgresql
        sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres'"

    - name: Install PostgreSQL ODBC driver
      run: |
        sudo apt-get install -y -q odbc-postgresql
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
        echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-postgresql
        path: |
          crusher-report.txt
          crusher-report.json

  # ── MariaDB on Linux ────────────────────────────────────────
  mariadb:
    name: MariaDB (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={MariaDB Unicode};Server=127.0.0.1;Port=3306;User=root;Password=root;"
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start MariaDB
      run: |
        sudo apt-get install -y -q mariadb-server
        sudo systemctl start mariadb
        sudo systemctl status mariadb
        sudo mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';"

    - name: Install MariaDB ODBC driver
      run: |
        sudo apt-get install -y -q odbc-mariadb
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mariadb
        path: |
          crusher-report.txt
          crusher-report.json

  # ── MySQL on Linux ──────────────────────────────────────────
  mysql:
    name: MySQL (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={MySQL};Server=127.0.0.1;Port=3306;User=crusher;Password=crusher;"
      MYSQL_ODBC_LIB_URL: https://dev.mysql.com/get/Downloads/Connector-ODBC/9.2/mysql-connector-odbc-9.2.0-linux-glibc2.28-x86-64bit.tar.gz
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start MySQL
      run: |
        sudo systemctl start mysql
        sudo systemctl status mysql
        # On Ubuntu 24.04, MySQL 8.4+ uses caching_sha2_password by default
        sudo mysql --defaults-file=/etc/mysql/debian.cnf -e "CREATE USER 'crusher'@'%' IDENTIFIED BY 'crusher'; GRANT ALL ON *.* TO 'crusher'@'%'; FLUSH PRIVILEGES;"
        mysql -u crusher -pcrusher -e "SELECT VERSION();"

    - name: Install MySQL ODBC driver
      run: |
        curl --no-progress-meter -LO "${MYSQL_ODBC_LIB_URL}"
        tar xzf mysql-connector-odbc-*.tar.gz
        DRIVER_DIR=$(ls -d mysql-connector-odbc-*/lib/)
        DRIVER_PATH=$(readlink -f ${DRIVER_DIR}/libmyodbc9w.so)
        echo "MySQL ODBC driver: ${DRIVER_PATH}"
        echo "[MySQL]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = MySQL ODBC Unicode Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(ls -d mysql-connector-odbc-*/lib/):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(ls -d mysql-connector-odbc-*/lib/):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mysql
        path: |
          crusher-report.txt
          crusher-report.json

  # ── MSSQL on Linux ──────────────────────────────────────────
  mssql:
    name: MSSQL (Linux)
    runs-on: ubuntu-latest
    env:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: "P@ssword2"
      ODBC_CONN: "Driver={ODBC Driver 18 for SQL Server};Server=tcp:127.0.0.1,1433;UID=sa;PWD=P@ssword2;TrustServerCertificate=yes;"
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start MSSQL Server
      env:
        ACCEPT_EULA: "1"
        MSSQL_SA_PASSWORD: "P@ssword2"
        MSSQL_PID: Developer
      run: |
        curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo gpg --batch --yes --dearmor -o /usr/share/keyrings/microsoft-prod.gpg
        curl -sSL https://packages.microsoft.com/config/ubuntu/24.04/mssql-server-preview.list | sudo tee /etc/apt/sources.list.d/mssql-server-preview.list
        sudo apt-get update -y -q
        sudo apt-get install -y -q mssql-server
        sudo -E /opt/mssql/bin/mssql-conf -n setup
        systemctl status mssql-server

    - name: Install MSSQL ODBC driver
      run: |
        curl -sSL -O https://packages.microsoft.com/config/ubuntu/24.04/packages-microsoft-prod.deb
        sudo dpkg -i packages-microsoft-prod.deb
        sudo apt-get update -y -q
        sudo apt-get install -y -q msodbcsql18
        cat /etc/odbcinst.ini

    - name: Wait for MSSQL to be ready
      run: |
        for i in $(seq 1 30); do
          /opt/mssql-tools18/bin/sqlcmd -S 127.0.0.1,1433 -U sa -P "P@ssword2" -C -Q "SELECT 1" && break
          echo "Waiting for MSSQL... ($i)"
          sleep 2
        done

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mssql
        path: |
          crusher-report.txt
          crusher-report.json

  # ── DuckDB on Linux ─────────────────────────────────────────
  duckdb:
    name: DuckDB (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={DuckDB Driver};"
      DUCKDB_ODBC_URL: https://github.com/duckdb/duckdb-odbc/releases/latest/download/duckdb_odbc-linux-amd64.zip
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Install DuckDB ODBC driver
      run: |
        mkdir duckdb_odbc
        cd duckdb_odbc
        curl --no-progress-meter -LO "${DUCKDB_ODBC_URL}"
        unzip -q duckdb_odbc-linux-amd64.zip
        DRIVER_PATH=$(readlink -f libduckdb_odbc.so)
        echo "DuckDB ODBC driver: ${DRIVER_PATH}"
        cd ..
        echo "[DuckDB Driver]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = DuckDB ODBC Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f duckdb_odbc):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f duckdb_odbc):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-duckdb
        path: |
          crusher-report.txt
          crusher-report.json

  # ── Oracle on Linux ─────────────────────────────────────────
  oracle:
    name: Oracle (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={Oracle};DBQ=//127.0.0.1:1521/XE;UID=system;PWD=tiger;"
      ORACLE_ODBC_LIB_URL1: https://download.oracle.com/otn_software/linux/instantclient/2326000/instantclient-basiclite-linux.x64-23.26.0.0.0.zip
      ORACLE_ODBC_LIB_URL2: https://download.oracle.com/otn_software/linux/instantclient/2326000/instantclient-odbc-linux.x64-23.26.0.0.0.zip
      ORACLE_ODBC_LIB_PATH: instantclient_23_26/libsqora.so.23.1
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev libaio1t64

    - name: Start Oracle (Docker)
      run: |
        docker run -id \
          --name oracle \
          -p 1521:1521 \
          -e ORACLE_PWD=tiger \
          container-registry.oracle.com/database/express

    - name: Install Oracle ODBC driver
      run: |
        curl --no-progress-meter -LO "${ORACLE_ODBC_LIB_URL1}"
        unzip instantclient-basiclite-linux.x64-23.26.0.0.0.zip
        curl --no-progress-meter -LO "${ORACLE_ODBC_LIB_URL2}"
        unzip -o instantclient-odbc-linux.x64-23.26.0.0.0.zip
        # Fix libaio symlink for Oracle
        pushd instantclient_23_26
        ln -sf /usr/lib/x86_64-linux-gnu/libaio.so.1t64.0.2 libaio.so.1
        popd
        DRIVER_PATH=$(readlink -f "${ORACLE_ODBC_LIB_PATH}")
        echo "Oracle ODBC driver: ${DRIVER_PATH}"
        echo "[Oracle]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = Oracle ODBC Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Wait for Oracle to be ready
      run: |
        echo "Waiting for Oracle XE to start (this can take 2-5 minutes)..."
        for i in $(seq 1 120); do
          if docker exec oracle sqlplus -s system/tiger@//localhost:1521/XE <<< "SELECT 1 FROM DUAL; EXIT;" 2>/dev/null | grep -q "1"; then
            echo "Oracle is ready!"
            break
          fi
          echo "Waiting for Oracle... ($i)"
          sleep 5
        done

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f instantclient_23_26):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f instantclient_23_26):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-oracle
        path: |
          crusher-report.txt
          crusher-report.json

  # ── DB2 on Linux ────────────────────────────────────────────
  db2:
    name: DB2 (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={DB2};HostName=127.0.0.1;Port=50000;Database=testdb;UID=db2inst1;PWD=testpwd;"
      DB2_ODBC_LIB_URL: https://github.com/staticlibs/odbclibs_tmp/releases/download/tmp1/v12.1.2_linuxx64_odbc_cli.tar.gz
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start DB2 (Docker)
      run: |
        mkdir db2_data
        docker run -id \
          --privileged=true \
          --name db2 \
          -p 50000:50000 \
          -e LICENSE=accept \
          -e DB2INST1_PASSWORD=testpwd \
          -e DBNAME=testdb \
          -v $(pwd)/db2_data/:/database \
          icr.io/db2_community/db2

    - name: Install DB2 ODBC driver
      run: |
        curl --no-progress-meter -LO "${DB2_ODBC_LIB_URL}"
        tar xzf v12.1.2_linuxx64_odbc_cli.tar.gz
        DRIVER_PATH=$(readlink -f odbc_cli/clidriver/lib/libdb2o.so)
        echo "DB2 ODBC driver: ${DRIVER_PATH}"
        echo "[DB2]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = IBM DB2 ODBC Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Wait for DB2 to be ready
      run: |
        echo "Waiting for DB2 to start (this can take 3-8 minutes)..."
        for i in $(seq 1 120); do
          if docker exec db2 su - db2inst1 -c "db2 connect to testdb" 2>/dev/null | grep -qi "completed"; then
            echo "DB2 is ready!"
            break
          fi
          echo "Waiting for DB2... ($i)"
          sleep 5
        done
        # Double check after a short delay (DB2 restarts the instance after init)
        sleep 15
        docker exec db2 su - db2inst1 -c "db2 connect to testdb" || true

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f odbc_cli/clidriver/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f odbc_cli/clidriver/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-db2
        path: |
          crusher-report.txt
          crusher-report.json

  # ── ClickHouse on Linux ─────────────────────────────────────
  clickhouse:
    name: ClickHouse (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={ClickHouse};Server=127.0.0.1;Port=8123;"
      CLICKHOUSE_ODBC_LIB_URL: https://github.com/ClickHouse/clickhouse-odbc/releases/download/1.4.3.20250807/clickhouse-odbc-linux-Clang-UnixODBC-Release.zip
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start ClickHouse
      run: |
        curl --no-progress-meter -fsSL 'https://packages.clickhouse.com/rpm/stable/repodata/repomd.xml.key' | sudo gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
        ARCH=$(dpkg --print-architecture)
        echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg arch=${ARCH}] https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
        sudo apt-get update -y -q
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -q clickhouse-server
        sudo systemctl start clickhouse-server
        sudo systemctl status clickhouse-server

    - name: Install ClickHouse ODBC driver
      run: |
        curl --no-progress-meter -LO "${CLICKHOUSE_ODBC_LIB_URL}"
        unzip clickhouse-odbc-linux-Clang-UnixODBC-Release.zip
        tar xJf clickhouse-odbc-1.4.3-Linux.tar.xz
        DRIVER_PATH=$(readlink -f clickhouse-odbc-1.4.3-Linux/lib/libclickhouseodbcw.so)
        echo "ClickHouse ODBC driver: ${DRIVER_PATH}"
        echo "[ClickHouse]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = ClickHouse ODBC Unicode Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f clickhouse-odbc-1.4.3-Linux/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f clickhouse-odbc-1.4.3-Linux/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-clickhouse
        path: |
          crusher-report.txt
          crusher-report.json

  # ── Firebird on Windows ─────────────────────────────────────
  firebird:
    name: Firebird (Windows)
    runs-on: windows-latest
    env:
      ODBC_CONN: "Driver={Firebird ODBC Driver};Database=localhost:C:/tmp/test.fdb;UID=SYSDBA;PWD=masterkey;CHARSET=UTF8;"
    steps:
    - name: Install Firebird Server
      shell: bash
      run: |
        choco install firebird --version 5.0.3.1 --no-progress
        export ISQL_EXE="C:/Program Files/Firebird/Firebird_5_0/isql.exe"
        echo "CREATE OR ALTER USER SYSDBA PASSWORD 'masterkey' USING PLUGIN Srp; EXIT;" | "${ISQL_EXE}" -b -user SYSDBA security.db
        mkdir -p "C:/tmp"
        echo "CREATE DATABASE 'localhost:C:/tmp/test.fdb' user 'SYSDBA' password 'masterkey'; EXIT;" | "${ISQL_EXE}" -b -q

    - name: Install Firebird ODBC driver
      shell: bash
      run: |
        choco install firebird-odbc --version 3.0.1.21 --pre --no-progress
        # List registered ODBC drivers
        powershell.exe -Command "Get-OdbcDriver | Format-Table Name, Platform"

    - name: Download odbc-crusher
      shell: bash
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-windows-x64.zip" --dir .
        unzip odbc-crusher-windows-x64.zip
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt || true
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -o json -f crusher-report.json || true
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-firebird
        path: |
          crusher-report.txt
          crusher-report.json

  # ── Mock Driver on Windows ──────────────────────────────────
  mock-driver:
    name: Mock Driver (Windows)
    runs-on: windows-latest
    env:
      ODBC_CONN: "Driver={Mock ODBC Driver};Mode=Success;Catalog=Default;ResultSetSize=100;"
    steps:
    - name: Download mock driver
      shell: bash
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "mock-odbc-driver-windows-x64.zip" --dir .
        unzip mock-odbc-driver-windows-x64.zip -d mock-driver
        ls -la mock-driver/
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Register Mock Driver
      shell: powershell
      run: |
        $driverDest = "C:\Windows\System32\mockodbc.dll"
        Copy-Item mock-driver\mockodbc.dll -Destination $driverDest
        & mock-driver\register.ps1 -DriverPath $driverDest

    - name: Download odbc-crusher
      shell: bash
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-windows-x64.zip" --dir .
        unzip odbc-crusher-windows-x64.zip
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt || true
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -o json -f crusher-report.json || true
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mock-driver
        path: |
          crusher-report.txt
          crusher-report.json
