name: Stress Test

on:
  workflow_dispatch:

jobs:

  # ── PostgreSQL on Linux ─────────────────────────────────────
  # Driver: psqlodbc 16.00.0000 (Ubuntu 24.04 apt package)
  # Source: https://github.com/postgresql-interfaces/psqlodbc
  # Tag:    REL-16_00_0000
  postgresql:
    name: PostgreSQL (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={PostgreSQL Unicode};Server=127.0.0.1;Port=5432;Database=postgres;Uid=postgres;Pwd=postgres;"
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start PostgreSQL
      run: |
        sudo systemctl start postgresql
        sudo systemctl status postgresql
        sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres'"

    - name: Install PostgreSQL ODBC driver
      run: |
        sudo apt-get install -y -q odbc-postgresql
        dpkg -s odbc-postgresql | grep Version
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
        echo "EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-postgresql
        path: |
          crusher-report.txt
          crusher-report.json

  # ── MariaDB on Linux ────────────────────────────────────────
  # Driver: MariaDB Connector/ODBC 3.1.15 (Ubuntu 24.04 apt package)
  # Source: https://github.com/mariadb-corporation/mariadb-connector-odbc
  # Tag:    3.1.15
  mariadb:
    name: MariaDB (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={MariaDB Unicode};Server=127.0.0.1;Port=3306;User=root;Password=root;"
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start MariaDB
      run: |
        sudo apt-get install -y -q mariadb-server
        sudo systemctl start mariadb
        sudo systemctl status mariadb
        sudo mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED BY 'root';"

    - name: Install MariaDB ODBC driver
      run: |
        sudo apt-get install -y -q odbc-mariadb
        dpkg -s odbc-mariadb | grep Version
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mariadb
        path: |
          crusher-report.txt
          crusher-report.json

  # ── MySQL on Linux ──────────────────────────────────────────
  # Driver: MySQL Connector/ODBC 9.2.0 (binary download)
  # Source: https://github.com/mysql/mysql-connector-odbc
  # Tag:    9.2.0
  mysql:
    name: MySQL (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={MySQL};Server=127.0.0.1;Port=3306;User=crusher;Password=crusher;"
      MYSQL_ODBC_VERSION: "9.2.0"
      MYSQL_ODBC_LIB_URL: https://dev.mysql.com/get/Downloads/Connector-ODBC/9.2/mysql-connector-odbc-9.2.0-linux-glibc2.28-x86-64bit.tar.gz
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start MySQL
      run: |
        sudo systemctl start mysql
        sudo systemctl status mysql
        # On Ubuntu 24.04, MySQL 8.4+ uses caching_sha2_password by default
        sudo mysql --defaults-file=/etc/mysql/debian.cnf -e "CREATE USER 'crusher'@'%' IDENTIFIED BY 'crusher'; GRANT ALL ON *.* TO 'crusher'@'%'; FLUSH PRIVILEGES;"
        mysql -u crusher -pcrusher -e "SELECT VERSION();"

    - name: Install MySQL ODBC driver
      run: |
        curl --no-progress-meter -LO "${MYSQL_ODBC_LIB_URL}"
        tar xzf mysql-connector-odbc-*.tar.gz
        DRIVER_DIR=$(ls -d mysql-connector-odbc-*/lib/)
        DRIVER_PATH=$(readlink -f ${DRIVER_DIR}/libmyodbc9w.so)
        echo "MySQL ODBC driver ${MYSQL_ODBC_VERSION}: ${DRIVER_PATH}"
        echo "[MySQL]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = MySQL ODBC Unicode Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(ls -d mysql-connector-odbc-*/lib/):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(ls -d mysql-connector-odbc-*/lib/):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mysql
        path: |
          crusher-report.txt
          crusher-report.json

  # ── DuckDB on Linux ─────────────────────────────────────────
  # Driver: DuckDB ODBC 1.4.4.0 (binary download)
  # Source: https://github.com/duckdb/duckdb-odbc
  # Tag:    v1.4.4.0
  duckdb:
    name: DuckDB (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={DuckDB Driver};"
      DUCKDB_ODBC_VERSION: "1.4.4.0"
      DUCKDB_ODBC_URL: https://github.com/duckdb/duckdb-odbc/releases/download/v1.4.4.0/duckdb_odbc-linux-amd64.zip
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Install DuckDB ODBC driver
      run: |
        mkdir duckdb_odbc
        cd duckdb_odbc
        curl --no-progress-meter -LO "${DUCKDB_ODBC_URL}"
        unzip -q duckdb_odbc-linux-amd64.zip
        DRIVER_PATH=$(readlink -f libduckdb_odbc.so)
        echo "DuckDB ODBC driver ${DUCKDB_ODBC_VERSION}: ${DRIVER_PATH}"
        cd ..
        echo "[DuckDB Driver]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = DuckDB ODBC Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f duckdb_odbc):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f duckdb_odbc):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-duckdb
        path: |
          crusher-report.txt
          crusher-report.json

  # ── ClickHouse on Linux ─────────────────────────────────────
  # Driver: ClickHouse ODBC 1.5.0.20251127 (binary download)
  # Source: https://github.com/ClickHouse/clickhouse-odbc
  # Tag:    v1.5.0.20251127
  clickhouse:
    name: ClickHouse (Linux)
    runs-on: ubuntu-latest
    env:
      ODBC_CONN: "Driver={ClickHouse};Server=127.0.0.1;Port=8123;"
      CLICKHOUSE_ODBC_VERSION: "1.5.0"
      CLICKHOUSE_ODBC_TAG: "v1.5.0.20251127"
      CLICKHOUSE_ODBC_LIB_URL: https://github.com/ClickHouse/clickhouse-odbc/releases/download/v1.5.0.20251127/clickhouse-odbc-linux-Clang-UnixODBC-Release.zip
    steps:
    - name: Install unixODBC
      run: |
        sudo apt-get update -y -q
        sudo apt-get install -y -q unixodbc unixodbc-dev

    - name: Start ClickHouse
      run: |
        curl --no-progress-meter -fsSL 'https://packages.clickhouse.com/rpm/stable/repodata/repomd.xml.key' | sudo gpg --dearmor -o /usr/share/keyrings/clickhouse-keyring.gpg
        ARCH=$(dpkg --print-architecture)
        echo "deb [signed-by=/usr/share/keyrings/clickhouse-keyring.gpg arch=${ARCH}] https://packages.clickhouse.com/deb stable main" | sudo tee /etc/apt/sources.list.d/clickhouse.list
        sudo apt-get update -y -q
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y -q clickhouse-server
        sudo systemctl start clickhouse-server
        sudo systemctl status clickhouse-server

    - name: Install ClickHouse ODBC driver
      run: |
        curl --no-progress-meter -LO "${CLICKHOUSE_ODBC_LIB_URL}"
        unzip clickhouse-odbc-linux-Clang-UnixODBC-Release.zip
        tar xJf clickhouse-odbc-${CLICKHOUSE_ODBC_VERSION}-Linux.tar.xz
        DRIVER_PATH=$(readlink -f clickhouse-odbc-${CLICKHOUSE_ODBC_VERSION}-Linux/lib/libclickhouseodbcw.so)
        echo "ClickHouse ODBC driver ${CLICKHOUSE_ODBC_VERSION}: ${DRIVER_PATH}"
        echo "[ClickHouse]" | sudo tee -a /etc/odbcinst.ini
        echo "Description = ClickHouse ODBC Unicode Driver" | sudo tee -a /etc/odbcinst.ini
        echo "Driver = ${DRIVER_PATH}" | sudo tee -a /etc/odbcinst.ini
        cat /etc/odbcinst.ini

    - name: Download odbc-crusher
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-linux-x64.tar.gz" --dir .
        tar xzf odbc-crusher-linux-x64.tar.gz
        chmod +x odbc-crusher
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      run: |
        export LD_LIBRARY_PATH=$(readlink -f clickhouse-odbc-${CLICKHOUSE_ODBC_VERSION}-Linux/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      run: |
        export LD_LIBRARY_PATH=$(readlink -f clickhouse-odbc-${CLICKHOUSE_ODBC_VERSION}-Linux/lib):$LD_LIBRARY_PATH
        ./odbc-crusher "${ODBC_CONN}" -o json -f crusher-report.json
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-clickhouse
        path: |
          crusher-report.txt
          crusher-report.json

  # ── Mock Driver on Windows ──────────────────────────────────
  mock-driver:
    name: Mock Driver (Windows)
    runs-on: windows-latest
    env:
      ODBC_CONN: "Driver={Mock ODBC Driver};Mode=Success;Catalog=Default;ResultSetSize=100;"
    steps:
    - name: Download mock driver
      shell: bash
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "mock-odbc-driver-windows-x64.zip" --dir .
        unzip mock-odbc-driver-windows-x64.zip -d mock-driver
        ls -la mock-driver/
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Register Mock Driver
      shell: powershell
      run: |
        $driverDest = "C:\Windows\System32\mockodbc.dll"
        Copy-Item mock-driver\mockodbc.dll -Destination $driverDest
        & mock-driver\register.ps1 -DriverPath $driverDest

    - name: Download odbc-crusher
      shell: bash
      run: |
        gh release download --repo fdcastel/odbc-crusher --pattern "odbc-crusher-windows-x64.zip" --dir .
        unzip odbc-crusher-windows-x64.zip
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Run odbc-crusher
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -v 2>&1 | tee crusher-report.txt || true
      continue-on-error: true

    - name: Run odbc-crusher (JSON)
      shell: bash
      run: |
        ./odbc-crusher.exe "${ODBC_CONN}" -o json -f crusher-report.json || true
      continue-on-error: true

    - name: Upload report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: report-mock-driver
        path: |
          crusher-report.txt
          crusher-report.json
